import{Cache,deep_copy,SettingsManager,Time}from"./utils.mjs";import*as bapi from"./api.js";class Net{static async fetch({data:{url:t,options:e}}){try{return await(await fetch(t,e)).text()}catch(t){return null}}}class Tab{static reloads={};static _reload({tab_id:e}){return new Promise(t=>bapi.browser.tabs.reload(e,{bypassCache:!0},t))}static async reload({tab_id:t,data:{delay:e,overwrite:a}={delay:0,overwrite:!0}}){e=parseInt(e);var s=Tab.reloads[t]?.delay-(Date.now()-Tab.reloads[t]?.start),s=isNaN(s)||s<0?0:s;return!!(a||0==s||e<=s)&&(clearTimeout(Tab.reloads[t]?.timer),Tab.reloads[t]={delay:e,start:Date.now(),timer:setTimeout(()=>Tab._reload({tab_id:t}),e)},!0)}static close({tab_id:e}){return new Promise(t=>bapi.browser.tabs.remove(e,t))}static async open({data:{url:t}}){bapi.browser.tabs.create({url:t})}static info({tab_id:t}){return new Promise(e=>{try{bapi.browser.tabs.get(t,t=>e(t))}catch(t){e(!1)}})}static active(){return new Promise(async e=>{var t;if("firefox"!==bapi.VERSION)return[t]=await bapi.browser.tabs.query({active:!0,lastFocusedWindow:!0}),e(t);bapi.browser.tabs.query({active:!0,lastFocusedWindow:!0},([t])=>{bapi.browser.runtime.lastError,e(t)})})}}class Settings{static data={};static _save(){return new Promise(t=>bapi.browser.storage.sync.set({settings:Settings.data},t))}static load(){return new Promise(e=>{var t=bapi.browser.storage;t?t.sync.get(["settings"],async({settings:t})=>{t?(Settings.data=t,Settings.data.version!==SettingsManager.DEFAULT.version&&(t=Settings.data.key,await Settings.reset(),Settings.data.key=t)):await Settings.reset(),Settings.data.key?.startsWith("MIIBI")&&(Settings.data.key=""),e()}):e()})}static async get(){return Settings.data}static async set({data:{id:t,value:e}}){Settings.data[t]=e,await Settings._save()}static async reset(){Settings.data=deep_copy(SettingsManager.DEFAULT);var t=bapi.browser.runtime.getManifest();t.nopecha_key&&(Settings.data.key=t.nopecha_key),await Settings._save()}}class Injector{static async _inject(e){e.target.tabId||(t=await Tab.active(),e.target.tabId=t.id);var t=new Promise(t=>bapi.browser.scripting.executeScript(e,t));return t}static async inject_func({tab_id:t,data:{func:e,args:a}}){t={target:{tabId:t,allFrames:!0},world:"MAIN",injectImmediately:!0,func:e,args:a};return Injector._inject(t)}static async inject_files({tab_id:t,frame_id:e,data:{files:a}}){t={target:{tabId:t,frameIds:[e]},world:"MAIN",injectImmediately:!0,files:a};return Injector._inject(t)}}class Recaptcha{static async reset({tab_id:t}){return await Injector.inject_func({tab_id:t,data:{func:()=>{try{window.grecaptcha?.reset()}catch{}},args:[]}}),!0}}class Server{static ENDPOINT="https://api.nopecha.com/status?v="+bapi.browser.runtime.getManifest().version;static in_progress=!1;static async get_plan({data:{key:t}}){if(Server.in_progress)return!1;Server.in_progress=!0;let e={plan:"Unknown",credit:0};try{"undefined"===t&&(t="");var a=await fetch(Server.ENDPOINT+"&k="+t);e=JSON.parse(await a.text())}catch{}return Server.in_progress=!1,e}}class Image{static b64({data:{url:t}}){return new Promise(a=>{fetch(t).then(t=>t.blob()).then(t=>{const e=new FileReader;e.onload=()=>a(e.result),e.readAsDataURL(t)})})}}class Relay{static async send({tab_id:t,data:e}){t=t||(await Tab.active()).id,bapi.browser.tabs.sendMessage(t,e)}}class Icon{static set_icon({data:a}){return new Promise(t=>{var e="firefox"===bapi.VERSION?bapi.browser.browserAction:bapi.browser.action;"on"===a?e.setIcon({path:{16:"/icon/16.png",32:"/icon/32.png",48:"/icon/48.png",128:"/icon/128.png"}},t):"off"===a?e.setIcon({path:{16:"/icon/16g.png",32:"/icon/32g.png",48:"/icon/48g.png",128:"/icon/128g.png"}},t):t(!1)})}static set_badge_text({tab_id:a,data:s}){return new Promise(t=>{var e={text:s};a&&(e.tabId=a),bapi.browser.action.setBadgeText(e,t)})}static set_badge_color({tab_id:a,data:s}){return new Promise(t=>{var e={color:s};a&&(e.tabId=a),bapi.browser.action.setBadgeBackgroundColor(e,t)})}static async set_badge({tab_id:t,data:{global:e,text:a,color:s}}){t||e||(t=(await Tab.active()).id),e&&(t=null);e=[Icon.set_badge_text({tab_id:t,data:a})];return s&&e.push(Icon.set_badge_color({tab_id:t,data:s})),Promise.all(e)}}const FN={set_cache:Cache.set,get_cache:Cache.get,remove_cache:Cache.remove,append_cache:Cache.append,empty_cache:Cache.empty,inc_cache:Cache.inc,dec_cache:Cache.dec,zero_cache:Cache.zero,fetch:Net.fetch,reload_tab:Tab.reload,close_tab:Tab.close,open_tab:Tab.open,info_tab:Tab.info,active_tab:Tab.active,get_settings:Settings.get,set_settings:Settings.set,reset_settings:Settings.reset,inject_files:Injector.inject_files,reset_recaptcha:Recaptcha.reset,get_server_plan:Server.get_plan,b64_image:Image.b64,relay:Relay.send,set_icon:Icon.set_icon};(async()=>{bapi.register_language(),await Settings.load(),await Icon.set_icon({data:Settings.data.enabled?"on":"off"}),bapi.browser.runtime.onMessage.addListener((e,a,s)=>((async()=>{["get_settings","set_settings","set_cache"].includes(e.method);try{var t=await FN[e.method]({tab_id:a?.tab?.id,frame_id:a?.frameId,data:e.data});return t}catch(t){throw t}})().then(s).catch(t=>{s(t)}),!0))})();
